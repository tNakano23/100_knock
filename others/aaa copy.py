import numpy as np
import statsmodels.api as sm
import matplotlib.pyplot as plt


T = list(range(100))
Y = [5.677224828078375, 5.159726264882809, 4.967506439851106, 3.5771389431769047, 4.5602524680937515,
     4.579182050584009, 3.736571113452893, 4.159604602739483, 5.33895401066004, 5.719061733482766,
     4.157204479449197, 3.7155616531253943, 5.592379562044069, 6.185469307894845, 5.402730459267373,
     5.155291226326003, 5.5952179349866915, 6.518430239445946, 6.003933683357983, 3.9234360052418964, 
     4.270898080352974, 4.375303351521952, 3.9088357843785593, 3.7662824439830125, 4.43549759744601, 
     4.660149327804114, 4.635435404338257, 5.046155382716264, 4.733480415555201, 4.113520409308739, 
     4.529127712446818, 5.163850585218215, 5.3715894027941085, 5.6452335680883134, 6.20884543104256,
     5.571080945029761, 5.5056169539029325, 7.963915134407991, 7.162632675757239, 5.091790011126058, 
     4.8029225958918, 5.221569985091175, 5.665355808040271, 5.586308477170571, 5.8109167094914635,
     5.183279626593114, 4.86162107512832, 4.578679688986616, 4.92087502152892, 4.446403654650716, 
     3.3907838290539702, 3.8666343507086065, 3.96952675519229, 4.897872696597754, 5.842065449865275,
     6.0418689883545325, 4.945818191940311, 3.833199802117725, 4.894270774519657, 4.503814941886753,
     4.47448056099909, 4.49033795433368, 4.610421040184575, 5.182210577794682, 5.046455563575459, 
     4.081668460907618, 4.213130473449276, 6.316218015454628, 6.119595909785953, 6.686830967373002, 
     6.492170227781602, 6.343010744231418, 6.253562606406951, 5.015549804574421, 5.559675088288723, 
     5.574451127322673, 5.673888714622507, 5.002657767778563, 5.2708662281634995, 5.766640693063566,
     4.855131289754543, 4.837563504630047, 5.128259009016214, 3.5365378756778636, 5.053402854108747,
     5.196025553098391, 5.209771439111303, 4.137925340414999, 3.7067148442005804, 4.3471903403972, 
     3.7769357606813463, 3.0335148148577007, 3.269228601716087, 4.653614782426736, 6.229007233169174,
     6.063015964137465, 6.052505765897191, 6.590411020647615, 5.741017402131981, 4.835800663398735]

# サンプルデータ生成（MR(3)に従う）
np.random.seed(42)
n = 100
true_mu = 5
true_theta = [0.5, -0.3, 0.1]  # θ1, θ2, θ3
noise = np.random.normal(0, 1, n)

# 時系列データ生成
X = [true_mu + noise[i] +
     true_theta[0] * noise[i-1] +
     true_theta[1] * noise[i-2] +
     true_theta[2] * noise[i-3] if i >= 3 else 0 for i in range(n)]

# モデルフィッティング
model = sm.tsa.ARIMA(X, order=(0, 0, 3))  # AR=0, I=0, MA=3
result = model.fit()

# 推定されたパラメータを取得
mu_hat = result.params.get('const', 0)  # 定常平均
theta_hat = [result.params[f'ma.L{i}'] for i in range(1, 4)]  # MAパラメータ

# 推定されたパラメータを表示
print("推定されたパラメータ:")
print(f"μ (定常平均): {mu_hat}")
for i, theta in enumerate(theta_hat, 1):
    print(f"θ{i}: {theta}")

# 結果の概要を表示
print("\nモデル概要:")
print(result.summary())

# 残差プロット
plt.figure(figsize=(10, 6))
plt.plot(result.resid, label="Residuals")
plt.axhline(0, color='red', linestyle='--', linewidth=0.8)
plt.title("Residuals")
plt.legend()
plt.show()
